name: Windows Build (MSYS2 / MinGW)

on:
  push:
    branches: [ master, upgrade ]
  pull_request:
    branches: [ master, upgrade ]
  workflow_dispatch:

env:
  VERSION: 0.7.2
  ICU_VERSION: 73-2
  SDL_MIXER_VERSION: 1.2.12

jobs:
  build:
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # 32-bit: Perl from MSYS2 core; ICU and SDL_mixer built from source
          - { icon: 'â¬›', sys: mingw32,    env: i686,          runs-on: 'windows-latest', host: 'i686-w64-mingw32',   build_deps: true,  continue: false }
          # 64-bit variants: full mingw-w64 packages available
          - { icon: 'ðŸŸ¦', sys: mingw64,    env: x86_64,        runs-on: 'windows-latest', host: 'x86_64-w64-mingw32', build_deps: false, continue: false }
          - { icon: 'ðŸŸ¨', sys: ucrt64,     env: ucrt-x86_64,   runs-on: 'windows-latest', host: 'x86_64-w64-mingw32', build_deps: false, continue: false }
          - { icon: 'ðŸŸ§', sys: clang64,    env: clang-x86_64,  runs-on: 'windows-latest', host: 'x86_64-w64-mingw32', build_deps: false, continue: false }
          # ARM64: requires GitHub Teams/Enterprise runner â€” optional
          - { icon: 'ðŸŸ©', sys: clangarm64, env: clang-aarch64, runs-on: 'windows-11-arm',  host: 'aarch64-w64-mingw32', build_deps: false, continue: true }

    name: ${{ matrix.icon }} ${{ matrix.sys }}
    continue-on-error: ${{ matrix.continue }}

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup MSYS2 (${{ matrix.sys }}) â€” base packages
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: true
          install: >-
            base-devel
            automake
            autoconf
            libtool
            unzip
            mingw-w64-${{ matrix.env }}-toolchain
            mingw-w64-${{ matrix.env }}-make
            mingw-w64-${{ matrix.env }}-pkg-config
            mingw-w64-${{ matrix.env }}-SDL
            mingw-w64-${{ matrix.env }}-SDL_image
            mingw-w64-${{ matrix.env }}-SDL_net
            mingw-w64-${{ matrix.env }}-freetype
            mingw-w64-${{ matrix.env }}-ntldd
            mingw-w64-${{ matrix.env }}-libiconv

      # â”€â”€ 64-bit: install Perl, ICU, SDL_mixer from pre-built packages â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install additional packages (64-bit)
        if: matrix.build_deps == false
        shell: msys2 {0}
        run: |
          pacman --noconfirm -S --needed \
            mingw-w64-${{ matrix.env }}-icu \
            mingw-w64-${{ matrix.env }}-perl \
            mingw-w64-${{ matrix.env }}-SDL_mixer

      # â”€â”€ 32-bit: mingw-w64-i686-perl/icu packages are unavailable or broken â”€
      - name: Install Perl for 32-bit (MSYS2 core Perl)
        if: matrix.build_deps == true
        shell: msys2 {0}
        run: |
          pacman --noconfirm -S perl
          perl --version
          which perl

      - name: Build ICU from source (32-bit)
        if: matrix.build_deps == true
        shell: msys2 {0}
        run: |
          cd /tmp
          wget https://github.com/unicode-org/icu/releases/download/release-73-2/icu4c-73_2-src.tgz
          tar xzf icu4c-73_2-src.tgz
          cd icu/source
          # Workaround for GCC 15.x __float128 / GLIBCXX_USE_FLOAT128 bug
          export CXXFLAGS="-O2 -std=c++11 -D__NO_INLINE__ -fext-numeric-literals -D_GLIBCXX_USE_FLOAT128=0"
          export CFLAGS="-O2 -D__NO_INLINE__"
          ./configure \
            --prefix=/mingw32 \
            --host=i686-w64-mingw32 \
            --disable-samples --disable-tests \
            --enable-static --disable-shared \
            --disable-renaming
          make -j$(nproc) || make
          make install

      - name: Build SDL_mixer from source (32-bit)
        if: matrix.build_deps == true
        shell: msys2 {0}
        run: |
          cd /tmp
          wget https://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-${{ env.SDL_MIXER_VERSION }}.tar.gz
          tar xzf SDL_mixer-${{ env.SDL_MIXER_VERSION }}.tar.gz
          cd SDL_mixer-${{ env.SDL_MIXER_VERSION }}
          ./configure --prefix=/${{ matrix.sys }} --host=i686-w64-mingw32
          make -j$(nproc)
          make install

      # â”€â”€ Paths, configure, build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Define paths
        shell: msys2 {0}
        run: |
          DIST="$(pwd)/distribution"
          BUILD="${DIST}/windows-${{ matrix.env }}_build"
          PKG="${DIST}/windows-${{ matrix.env }}_package"
          echo "DIST_FOLDER=${DIST}"             >> "$GITHUB_ENV"
          echo "PLATFORM_BUILD_PATH=${BUILD}"    >> "$GITHUB_ENV"
          echo "PLATFORM_PACKAGE_PATH=${PKG}"    >> "$GITHUB_ENV"
          # Windows-style paths for PowerShell / InnoSetup steps
          echo "WIN_PLATFORM_PACKAGE_PATH=$(cygpath -w "${PKG}")" >> "$GITHUB_ENV"

      - name: Configure project
        shell: msys2 {0}
        run: |
          export SDL_CONFIG="/${{ matrix.sys }}/bin/sdl-config"
          export PKG_CONFIG_PATH="/${{ matrix.sys }}/lib/pkgconfig"
          autoreconf -i -f
          ./configure \
            --prefix=/${{ matrix.sys }} \
            --host=${{ matrix.host }}

      - name: Build
        shell: msys2 {0}
        run: |
          make DESTDIR="${{ env.PLATFORM_BUILD_PATH }}" install -j$(nproc)

      - name: Collect DLLs and package
        shell: msys2 {0}
        run: |
          PREFIX="/${{ matrix.sys }}"
          BUILD="${{ env.PLATFORM_BUILD_PATH }}"
          PKG="${{ env.PLATFORM_PACKAGE_PATH }}"

          mkdir -p "${PKG}${PREFIX}/bin"
          mkdir -p "${PKG}${PREFIX}/share/openmortal"

          cp -a "${BUILD}${PREFIX}/share" "${PKG}${PREFIX}/"
          install -m755 "${BUILD}${PREFIX}/bin/openmortal.exe" \
                        "${PKG}${PREFIX}/bin/openmortal.exe"

          # Bundle required DLLs (exclude Windows system DLLs)
          ntldd -R "${BUILD}${PREFIX}/bin/openmortal.exe" \
            | grep -v -i "system32" \
            | grep -v -i "winsxs" \
            | grep -v -i "not found" \
            | awk '{print $3}' \
            | xargs -d '\n' -I{} cp -- "{}" "${PKG}${PREFIX}/bin/"

          tar zcvf "openmortal-${{ env.VERSION }}_windows_${{ matrix.env }}.tar.gz" \
            -C "${PKG}" .

      - name: Upload portable archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: openmortal-${{ env.VERSION }}_windows_${{ matrix.env }}
          path: openmortal-${{ env.VERSION }}_windows_${{ matrix.env }}.tar.gz

      # â”€â”€ InnoSetup installer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install InnoSetup 6
        shell: pwsh
        run: |
          if (-not (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe")) {
            choco install innosetup -y --no-progress
          }

      - name: Create .ico from PNG (ImageMagick)
        shell: pwsh
        run: |
          # magick (ImageMagick 7) is pre-installed on windows-latest runners
          magick "packaging\1024x1024\openmortal.png" `
            -define icon:auto-resize="256,128,64,48,32,16" `
            "packaging\openmortal.ico"

      - name: Build InnoSetup installer
        shell: pwsh
        run: |
          $iscc    = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          # Source dir is the staged package tree for this MSYS2 variant
          $srcDir  = "${{ env.WIN_PLATFORM_PACKAGE_PATH }}\${{ matrix.sys }}"

          New-Item -ItemType Directory -Force "packaging\installer" | Out-Null

          & $iscc `
            "/DSourceDir=$srcDir" `
            "/DAppArch=${{ matrix.env }}" `
            "packaging\openmortal.iss"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: openmortal-${{ env.VERSION }}_windows_${{ matrix.env }}_setup
          path: packaging/installer/openmortal-${{ env.VERSION }}-windows-${{ matrix.env }}-setup.exe
